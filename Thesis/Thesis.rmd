---
header-includes:
    \usepackage{float}
    \usepackage{epsfig}
    \usepackage{setspace}
output:
  pdf_document:
    extra_dependencies: ["float"]
fontsize: 12pt 
indent: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=F, message=F, fig.pos = "H", cache=F)
```

\newcommand{\doublerule}[1][.4pt]{%
  \noindent
  \makebox[0pt][l]{\rule[.7ex]{\linewidth}{#1}}%
  \rule[.3ex]{\linewidth}{#1}}
  
\newcommand{\raisedrule}[2][0pt]{%
  \leaders
  \hbox{%
    \makebox[0pt][l]{\rule[#1]{1pt}{#2}}%
    \rule[\dimexpr#1+.4ex]{1pt}{#2}%
  }\hfill}

\doublerule[1pt]

\begin{center}
\doublespacing
{\Large{\textsc{{Investigating the Role of School Homogeneity on Student Outcome Disparities in Chicago Public Elementary Schools}}}}%Thesis title
  
\doublerule[1pt]

\hfill\break

\singlespacing

\textsc{Katrina Wheelan}%Student's Name

\hfill\break


\textsc{Laurie Tupper, Advisor}%Advisor's Name Goes here


\textsc{Chad Topaz, Advisor}%Advisor's Name Goes here

 
 \hfill\break
 \hfill\break

```{r, out.width = "75px"}
knitr::include_graphics("Williams_College_Seal-eps-converted-to.pdf")
```

 
 \hfill\break
 \hfill\break

A thesis submitted in partial fulfillment\\ of the requirements for the
\\Degree of Bachelor of Arts with Honors\\ in Mathematics

 \hfill\break

\textsc{Williams College}
\\
Williamstown, Massachusetts

 \hfill\break

\today %automatically adds today's date

\thispagestyle{empty}

\end{center}

\pagebreak
```{r, include=F}

library(ggplot2)
library(tidyr)
library(dplyr)
library(tidycensus) #interacts with census API
library(sf) #shapefile package
library(ggplot2)
library(viridis) #for nice scaled geo plots
library(lwgeom)
library(reldist) #for gini index calculation
library(ape) #spatio-temporal methods
library(fitdistrplus) #fitting continuous dist to binned data
library(gglorenz) #plot Lorenz curve
library(ggfortify) #for diagnostic plots
library(gridExtra) # for nice side-by-side plots
library(lemon) # to share legends
library(knitr)

root = "~/Desktop/Thesis"

sample =read.csv("~/Desktop/Thesis/sample.txt")

elem_boundaries = st_read("~/Desktop/Thesis/Boundaries/SY19-20_elem_boundaries/19-20_boundaries.shx")
elem_boundaries = elem_boundaries %>% st_transform("NAD83")

elem.df = read.csv("~/Desktop/Thesis/elem_df.csv")
st_geometry(elem.df) = elem_boundaries$geometry

elem.df.2009 = read.csv("~/Desktop/Thesis/2009_elem_df.csv")
bounds2009 = st_read("~/Desktop/Thesis/Boundaries/SY08-09_elem_boundaries/08-09_boundaries.shx")
st_geometry(elem.df.2009) = bounds2009$geometry
```

\doublespacing

\begin{center}
\Large{\textsc{Abstract}}
\end{center}

Chicago’s long history of redlining led to dramatic racial and income-based residential segregation that persists today. As a result, many of Chicago’s neighborhood elementary schools exhibit high levels of racial and income homogeneity. In my thesis, I link neighborhood demographics to elementary school outcomes, and I use spatio-temporal methods to investigate the relationship between school homogeneity, neighborhood income inequality, and intra-school disparities in student outcomes in 2009 and 2019. I find that income inequality has no significant association with outcome distributions, but racial homogeneity has a generally significant and positive association with the spread of student outcomes. The significance and magnitudes of these predictors changed slightly from 2009 to 2019, potentially as a result of widespread school closures in 2013.

\newpage

\begin{center}
\Large{\textsc{Acknowledgements}}
\end{center}

I am extremely grateful to my thesis advisors Professor Tupper and Professor Topaz, who expertly guided me through the thesis writing process. I am also thankful for Julia Tucher, my podmate and thesis buddy. Sarah Dean provided wonderful editing and emotional support. Finally, I am grateful for my friends and family who graciously suffered through constantly hearing about my thesis.

\newpage

\begin{center}
\Large{\textsc{1. Introduction}}
\end{center}

Social scientists have conducted extensive research on the effects of wealth and racial disparities between districts on lifetime outcomes, but there has been comparatively little research about the relationship between classroom homogeneity and intra-school disparities in educational outcomes. In this paper, I investigate the extent to which the income and racial make-ups of schools and their neighborhoods affect the distribution of outcomes over time. I chose to focus on Chicago Public Schools because the city has a single school district and because readily available and extensive data exist. Chicago schools are also notorious for their racial homogeneity; in more than half of Chicago public elementary schools, at least 90% of the students identify as the same race.\footnote{Calculated from Illinois Board of Education Data}

To answer these questions, I use several high dimensional data sources. I rely heavily on the Illinois Department of Education data for each public elementary school in Chicago. These data include detailed demographic data, standardized testing scores, and other indicators at the school-level. I also use American Community Survey data, which provides detailed metrics about the characteristics of each Census tract. I employ spatio-temporal methods and traditional linear methods to analyze the effects of racial and income disparities on the distribution of testing outcomes across space (school zones) and time (school years). 

\newpage
\begin{center}
\Large{\textsc{2. Historical and Social Context}}
\end{center}

## 2.1 Historical Context

Throughout the United States, discriminatory housing laws and other government actions perpetuated and solidified residential segregation well into the civil rights era. Particularly in Chicago, city and federal government practices intensified and systematized racist housing practices, resulting in stark racial and socioeconomic segregation in both neighborhoods and schools. 

### 2.1.1 Residential Segregation in Chicago

After the Great Depression, new public housing projects reinforced racial residential segregation throughout the United States. In the 1930s, the New Deal Public Works Association constructed several  fully segregated housing projects in Chicago (Rothstein, 2017: 25). Over the following decades, the Chicago Housing Authority (CHA) continued to almost exclusively build public housing projects in predominantly Black neighborhoods while vetoing proposals in predominantly White neighborhoods (Ewing, 2018: 70). In the 1940s and 1950s, Chicago built more high-rise housing projects designated for Black families, including the infamous Robert Taylor and Cabrini Green Houses (Rothstein, 2017: 32). These projects enabled the CHA to solidify rigid residential segregation, confining low-income Black residents to small, inscribed areas. 

In the same period, “redlining,” or discriminatory lending practices, codified racial segregation and systematically denied families of color access to capital. As part of the New Deal, the Home Owners' Loan Corporation (HOLC), a government entity, began to rate residential blocks according to their creditworthiness. White homeowners feared that racial integration would cause "white flight" and send home prices plummeting. As a result, the creditworthiness classification fell closely along racial and ethnic boundaries, and residents of non-White neighborhoods generally faced more limited access to credit (Moser, 2017).

Redlining also intensified and codified existing racial segregation. Aaronson et al. (2020) find that redlining significantly affected housing patterns. They find that after the creation of the HOLC maps, families of color disproportionately moved to areas with lower grades while White families disproportionately moved to higher graded areas. Given that access to credit generally fell along racial lines, redlining contributed to the growing wealth disparity between White and Black Americans in Chicago and elsewhere in urban America. This wealth disparity has persisted and grown in the twenty-first century. In 2013, White households had thirteen times the total assets of Black households, a gap that is larger than three decades earlier (Ewing, 2018: 128).

### 2.1.2 School Segregation in Chicago

Since most Chicago children attend their neighborhood schools, the high levels of residential segregation were (and are) highly correlated with high levels of school segregation. After integration efforts in the second half of the twentieth century, residential desegregation efforts have progressed more quickly than school desegregation efforts (Vigdor and Ludwig, 2008). However, the national trend toward school integration has recently stalled or reversed in some places (Vigdor and Ludwig, 2008). 

In 1999, Chicago mayor Richard M. Daley announced his “Plan for Transformation.” The plan authorized the CHA to demolish almost 22,000 units of public housing, primarily in predominantly Black neighborhoods in the South Side of Chicago (Ewing, 2018: 86). This policy both displaced thousands of Black families and it did little to integrate Chicago neighborhoods. A major effect of the plan was a dramatic decrease in student enrollment for the elementary schools formerly serving the demolished housing projects (Ewing, 2018: 87). 

As I confirm later in the paper, Chicago neighborhoods and their local elementary schools remain highly segregated. For instance, in the typical (median) predominantly Black neighborhood in 2019, 97% of the residents were Black and 96% of the neighborhood elementary school students were Black. For Hispanic students, schools remain more segregated than neighborhoods. In the typical predominantly Hispanic neighborhood in 2019, 78% of residents were Hispanic, and 92% of neighborhood elementary school students were Hispanic.\footnote{Calculated from ISBE and Census data}

### 2.1.3 History and Structure of Chicago Public Schools

The Chicago Public Schools (CPS) represent a unified school district serving the entire city of Chicago. In the 2020-21 school year, CPS operated 638 schools serving 340,658 total students (CPS, 2021). Every child living in Chicago is guaranteed a slot in their neighborhood elementary school. These elementary school attendance boundaries change year-to-year, but with only slight variations.

In recent years, CPS has made efforts to increase school choice, opening magnet and technical schools. Although much of this effort has been targeted at high schools, magnet elementary schools and other open-enrollment elementary schools also exist. Unlike CPS high school students, the majority of CPS elementary school students attend their neighborhood school (Hing, 2016). Low-income and young students are especially likely to attend their neighborhood school given parental time and resource constraints on transportation. 

In 2004, CPS announced its Renaissance 2010 plan, which proposed opening 100 new schools, including many charter schools. In order to open new schools, CPS proposed closing “failing schools” throughout the city (Ewing, 2018: 112). Although CPS has not yet built 100 new schools, CPS did close many schools. In 2013, Mayor Rahm Emanuel announced that 54 schools would be shuttered (Ewing, 2018: 2). 

The schools slated to close served a disproportionate number of students of color, especially Black students. 90% of the school closures applied to majority Black schools, and 71% of the schools employed mostly Black teachers. These same schools served a disproportionate number of low-income, special education, and remedial students. Most of these displaced students ended up in equally segregated schools after the closings, and almost half of these displaced students (42%) ended up in the lowest-ranking schools in the city (Ewing, 2018: 5-8).

## 2.2 Review of Relevant Social Science Research

Although relatively few studies focus specifically on the effects of income and racial heterogeneity on the distributions of student outcomes, a great deal of related research exists. 

### 2.2.1 Segregation’s Effects on Student Outcomes

Throughout the United States, there are significant racial achievement gaps, especially between Black and White students. Integration in the late twentieth century coincided with a narrowing of the Black-White achievement gap (Vigdor and Ludwig, 2008). Although this coincidence is not necessarily causal, there are several potential causal relationships. Students of color may have gained access to generally better-resourced schools, or school homogeneity itself may contribute to more disparate outcomes. 

However, linking segregation and school homogeneity to student outcome disparities is complex for a number of reasons. First, students’ race is closely associated with both students’ incomes and the resources of the school. Second, highly segregated schools are generally a product of high levels of residential segregation. Thus, racial homogeneity may be a stand in for socio-economic status, school quality, or neighborhood characteristics. 

### 2.2.2 Income Effects on Student Outcomes

Income has a small but statistically significant effect on test scores; across the nation, lower income students underperform their more affluent peers (Phillips et al. 1998). Lower income students are more likely to attend less well-resourced schools, they are more likely to live in poorer neighborhoods, and they are more likely to live in households with fewer material resources and less educated families. This income-based achievement gap is still growing. In particular, the achievement gap between children at the 10th and 90th percentiles of the income distribution has been widening for the last 50 years (Reardon, 2011).

Although much of the income disparities are linked to differences in school quality, the school quality effect does not explain the entirety of the income-based outcome disparity. Papay et al. (2015) find that Massachusetts students in the same high school who share similar non-income characteristics, eighth grade test scores, and eighth grade attendance still face significant income-based achievement gaps in later grades (Papay et al., 2015). Clearly, other factors, including neighborhood characteristics, play an important role in perpetuating outcome disparities.

There may also be a link between the distribution of income and student test scores. Over the last few decades, income inequality has increased dramatically. While racial segregation has declined since 1970 (Vigdor and Ludwig, 2008), income segregation has increased (Watson, 2006). Some researchers suggest a causal link may exist between increasing income inequality and racial test score disparities. Campbell et al. (2008) find some evidence that income inequality within schools affects test scores, especially for Black students. 

Income and racial segregation may also act jointly. For example, Kreiger et al. (2015) find significantly worse health outcomes for individuals living in areas with high indices of concentration of the extremes (ICE), a metric which captures the extremes of racial and income privilege or disadvantage. Areas that are predominantly non-White and low-income may experience what Perkins and Sampson (2015) call “compounded deprivation,” which captures the intersectional nature of poverty. Many individual and neighborhood drivers and consequences of poverty -- such as high rates of violence, low educational attainment, housing insecurity, job insecurity, low levels of local investment, and material deprivation -- interact with and exacerbate each other. Black adolescents in Chicago are significantly more likely to experience compounded deprivation than adolescents of other races in Chicago (Perkins and Sampson, 2015).

Chicago neighborhoods tend to be fairly homogeneous in terms of income. Income-homogeneous neighborhoods in Chicago tend to have stable housing patterns, while “mixed middle-income” neighborhoods tend to be less stable (Sampson et al., 2015). In a study that followed 700 Chicago teenagers from 1995 to 2013, Hispanic Chicagoans were significantly more likely than White or Black Chicagoans to have exposure to mixed-income neighborhoods. This suggests that while stark economic inequality exists at the city level, many students may not be exposed to high levels of income inequality at the neighborhood or school level.

### 2.2.3 Peer Effects in the Classroom

Although there has been comparatively little research conducted on the effects of homogeneity in the classroom, there is well-documented evidence of general peer effects on elementary school performance. In particular, Project STAR randomized kindergarten through third grade classrooms for more than 11,000 public school students in Tennessee and then tracked the students' outcomes. Chetty et al. (2011) find that students who were assigned to “higher quality” classrooms (with higher preforming peers) acheived short-term gains in standardized test scores. Most dramatically, the researchers found a significant association between “higher quality” classrooms and long-term outcomes, including earnings and graduation rates. These significant and long-lasting peer effects suggest that students' classmates matter in early elementary school.

\newpage
\begin{center}
\Large{\textsc{3. Data Discussion}}
\end{center}


```{r, include =F}
sum(elem.df.2009$total.students, na.rm=T)
sum(elem.df$total.students, na.rm=T)

sum(elem.df.2009$population, na.rm=T)
sum(elem.df$population, na.rm=T)
```

## 3.1 Overview

I combined and aggregated several sources to generate a high-dimensional dataframe containing the relevant demographic and student performance data. My final dataframe contains 96 variables across `r dim(elem.df.2009)[1]` schools in 2009 and `r dim(elem.df)[1]` schools in 2019. This represents 165,079 students in 2009 and 192,617 students in 2019, as well as 2,715,471 residents in 2009 and 2,714,595 residents in 2019.

For this analysis, I focus on data from a 10 year period, comparing results from 2009 and 2019.
I rely on several public data sources at multiple geographic levels, including the decennial Census, the American Community Survey (ACS), the Illinois State Board of Education (ISBE), and Chicago Public Schools (CPS). Table 1 details the specific data sources and their level of granularity.

\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c }
\hline
\hline
  \\
 Variable & Source & Time Scale & Space Scale  \\ 

 \hline
 \\
 Population & Decennial Census & 10 years & block\\
 Race/ethnicity of residents & Decennial Census & 10 years & block\\
 Median rent & ACS & 5 years & block group\\
 Median household income & ACS & 5 years & block group\\
 Personal income category & ACS & 5 years & tract\\
 Proportion of home owners & ACS & 5 years & tract\\
 School race/ethnicity proportions & ISBE & 1 year & school boundary\\
 School low income/English learner proportions & ISBE & 1 year & school boundary\\
 School test scores by grade and subject & ISBE & 1 year & school boundary\\
 Elementary school boundaries & CPS & 1 year & school boundary\\
 
 \hline
\end{tabular}
\caption{Source Data Details}
\label{table:1}
\end{table}
\end{center}


## 3.2 Demographic Data

Since the school demographics often differ from the neighborhood demographics, I also use the decennial U.S. Census and the American Community Survey (ACS) for neighborhood demographics. The ACS is a longer form version of the Census questionaire, which the U.S. Census Bureau administers to a random sample of American households every year. These annual results are aggregated over five year periods. Unlike the U.S. Census, the ACS collects information about individual and household income. 

I use block-level data from the decennial Census, and I use block-group and tract level data from the ACS. A Census block is a highly granular geographic division; the United States is split into more than seven million Census blocks. A block-group typically consists of 39 Census blocks and between 600 and 3,000 residents. Census tracts are slightly larger and contain one or several block groups with an optimal population of 4,000 residents. 

Although the Census classifies "Hispanic" as an ethnic identity, the Illinois Board of Education classifies "Hispanic" as a racial category. To reconcile this difference, I classify "Hispanic" as a mutually exclusive racial category. 

## 3.3 School Data

The Illinois State Board of Education (ISBE) provides public data on annual school "report cards," including information about school demographics and test scores. Test data are specific to the grade and school, while demographic data are aggregated to the school level. I supplement the state-provided data with shape files from the Chicago Public Schools (CPS), which contain the attendance boundaries for public elementary schools. 

The test score data include the number of students in each grade who test at each proficiency level. After the 2013-2014 academic year, Illinois transitioned from the ISAT (Illinois Standardized Assessment Test) to the PARCC (Partnership for Assessment of Readiness for College and Career), which was in turn replaced by the IAR (Illinois Assessment of Readiness) in 2019. All three exams have multiple proficiency levels, but the ISAT uses four proficiency levels, while the PARCC and IAR scores use five levels (did not meet, partially met, approached, met, and exceeded expectation).

Most Chicago elementary schools limit enrollment to their elementary school boundaries, but some schools are open enrollment or "magnet" schools. Magnet schools do not have attendance boundaries, so their student body may not reflect the demographics of the neighborhood as a whole. Most elementary schools primarily serve students living in the neighborhood, but I discuss exceptions in section 6.3.

## 3.4 Response Rates

The annual response rate for the ACS is consistently above 92%. 2019 was an exception because the government shutdown paused survey-taking. The response rate in 2019 was 86% (U.S. Census Bureau, 2021). Non-response to the decennial Census is penalized by law, so its (pre-COVID) reponse rates have been consistently above 99% (U.S. Census Bureau, 2021).

The state of Illinois mandates standardized test participation for public school students, with few exceptions (such as significant cognitive disabilities). As a result, the student participation rate is close to comprehensive. In 2019, the mean participation rate across CPS elementary schools was 97.19%.\footnote{Calculated from ISBE data}


\newpage
\begin{center}
\Large{\textsc{4. Methodology}}
\end{center}


## 4.1 Weighting Demographic Data

I investigate the role of location, racial homogeneity, income inequality, and other demographic factors in determining the distribution of student outcomes. In order to use demographic variables, I had to reconcile the geographic boundaries of the Census data with the elementary school boundaries.

### 4.1.1 Weighting Overview 

In Cook County, Illinois, there are nearly 100,000 blocks, distributed among more than 350 elementary school boundaries. Specifically, for Chicago in 2019:

\singlespacing
$$
\begin{aligned}
m &= \text{number of blocks} = 99,042\\
n &= \text{number of block groups} = 3,993\\
t &= \text{number of tracts} = 1,319\\
s &= \text{number of schools} = 356\\
\end{aligned}
$$
\doublespacing

\  

Most Census blocks are fully contained in a single school boundary, so I aggregated the block-level demographics to the elementary school boundary level. However, most Census block groups and tracts are not fully contained in a single school boundary. To calculate the appropriate school boundary level data, I weight the block group and tract level data by block populations. 

```{r, echo=F, out.height = "90%", fig.align="center", fig.cap= "Weighting method demonstration for John Hay Elementary Community Academy. The elementary school boundary shown in red, and the Census tract boundaries are shown in black. Darker blocks reflect high population density."}
include_graphics("/Users/williamsuser/Desktop/Thesis/Plots/HAY_panel.PNG")
```

Figure 1 illustrates this weighting method for John Hay Elementary Community Academy's 2009 boundary. Panel A shows the elementary school boundary, outlined in red, as well as each block in the boundary. The blocks are filled according to their population; darker blocks are more populous. White blocks are not populated. In Panel B, four relevant Census tracts are overlaid, with black boundaries. In Panel C, we see the aggregated populations across all blocks in the four areas overlapping each Census tract. The weights for each tract correspond to their contribution to the total population of the school neighborhood. For instance, the purple tract on the bottom left contains 73% of the population of Hay's school boundary, so it receives a tract weight of 0.73 for Hay Academy. These tract weights are multiplied by tract-level variables to generate school boundary level data.

### 4.1.2 Weighting Calculations 

To transform the tract level data to elementary school boundary level data, I constructed matrix $\bf{POP(tract)}$. As an intermediate step, I use matrix $\bf{Z}$ to hold information on the blocks contained in each boundary. Row $k$ of the $\bf{Z}$ matrix will contain a 1 in column $i$ when boundary $k$ contains block $i$. Similarly, row $i$ of the $\bf{Y}$ matrix will contain a 1 in column $p$ when tract $p$ contains block $i$. The center matrix in the product below is a diagonal matrix containing the population of block $i$ in row and column $i$. 

Multiplying as below yields a and $s \times t$ matrix, which  I will use to weight tract level data. Entry $\bf{POP}({tract})_{kp}$ gives the population of the overlapping area between tract $p$ and school boundary $k$.

\begin{equation}
\bf{POP(\text{tract})}_{s \times t} =
\begin{pmatrix}
z_{11} & \dots & z_{1m} \\
\vdots & & \vdots \\
z_{s1} & \dots & z_{sm}\\
\end{pmatrix}
\begin{pmatrix}
pop_{1} & \dots & 0 \\
\vdots & \ddots & \vdots \\
0 & \dots & pop_m\\
\end{pmatrix}
\begin{pmatrix}
y_{11} & \dots & y_{1t} \\
\vdots & & \vdots \\
y_{m1} & \dots & y_{mt}\\
\end{pmatrix}
\end{equation}

\singlespacing
$$
\begin{aligned}
\text{Where: }\\
pop_i &= \text{Population of block }i\\
z_{ki} &=  \begin{cases} 
      0 & \text{if block }i\text{ not in school boundary }k\\
      1 & \text{if block }i\text{ in school boundary }k
   \end{cases}\\
y_{ip} &=  \begin{cases} 
      0 & \text{if block }i\text{ not in tract }p\\
      1 & \text{if block }i\text{ in tract }p
   \end{cases}\\
\end{aligned}
$$
 
\  

\doublespacing
I then scale $\bf{POP(tract)}$ with the total population of each school boundary to get the proportion of residents in each school boundary living in each tract. We'll call this new weight matrix $\bf{W}$.

$$
\begin{aligned}
\bf{W}_{s \times t} &=  
\begin{pmatrix}
\frac{1}{\sum_{i \in school_1}pop_i} & \dots & 0\\ 
\vdots & \ddots & \vdots\\
0 & \dots & \frac{1}{\sum_{i \in school_s}pop_i}\\
\end{pmatrix}
\bf{POP(tract)}\\
\end{aligned}
$$

Then, we can weight the tract-level demographics, like median household income, as below:

$$
\begin{aligned}
\begin{pmatrix}
income_1 \\
\vdots\\
income_s\\
\end{pmatrix} &=  
\bf{W}
\begin{pmatrix}
income_1 \\
\vdots\\
income_n\\
\end{pmatrix}
\end{aligned}
$$

This yields a an $s \times 1$ matrix with an estimate for the median household income in each elementary school boundary. The process for weighting block group level data is analogous to that of tract-level data. 

### 4.1.3 Weighting Limitations 

This method weights each tract according to the population of its overlap with the school district of interest. Using population weights, rather than area weights, accounts for heterogeneity of the population density within the boundaries. 

However, one limitation of this method is the assumption that the area of a tract overlapping an elementary school boundary represents the entire tract. In reality, tracts may not be homogeneous, especially on either side of a school boundary. For instance, a better neighborhood school on one side of a tract might drive up property values and attract higher income residents. 


## 4.2 Measuring Racial Homogeneity

I considered three metrics to quantify racial homogeneity. First, I considered a chi-squared statistic to compare a school's racial split to the Chicago Public School overall racial split. This metric essentially quantifies a school's deviation from the null distribution, but such a deviation does not necessarily mean greater racial homogeneity. I do not ultimately use this metric in my final analysis. 

I also considered a second metric: the proportion of students who belong to the largest racial group in a school. This metric, lg, is rigorously defined below for school $s$ across all racial classifications $R$:

\begin{equation}
lg_s = argmax_{i \in R}\{race.prop_{si}\}
\end{equation}

The third metric is fractionalization, which I ultimately use. This metric is defined as the probability that two students in a given school do not belong to the same racial or ethnic group. This metric was most notably used by economists Williams Easterly and Ross Levine in a 1997 study of ethnic fractionalization in Africa (Easterly et al., 1997), I adjust this metric slightly; instead, I use the probability that two random students belong to the \emph{same} racial group.

\begin{equation}
Frac_s = \sum_{i \in R}race.prop_{si}^2
\end{equation}

Figure 2 illustrates ethnic fractionalization across schools.

```{r, echo = F, fig.cap="Fractionalization index by school. A fractionalization index of 1 represents a school that is single race."}
#elem.df[,26:30] = elem.df[,26:30]/100
#elem.df.2009[,23:27] = elem.df.2009[,23:27]/100
#elem.df$frac = rowSums(data.frame(elem.df)[,25:30]^2, na.rm = T)
#elem.df.2009$frac = rowSums((data.frame(elem.df.2009)[,22:27])^2, na.rm = T)
#elem.df$frac[(elem.df$frac == 0)] = NA
#elem.df.2009$frac[(elem.df.2009$frac == 0)] = NA

plot.map <- function (var, title="", limits=NA, colors=NA, option = NA, direction=1, begin=0, end=1, df=elem.df) {
  if(is.na(colors[1])){
    fill_scale = scale_fill_viridis(direction=direction, option = option, begin=begin, end=end)
  } else {
    if(is.na(limits[1])){
      limits = c(min(var, na.rm = T), mean(var, na.rm=T), max(var, na.rm=T))
    }
    fill_scale = scale_fill_gradient2(high=colors[1], 
                                      low=colors[3], 
                                      mid=colors[2], 
                                      midpoint=limits[2],
                                      limits= c(limits[1],limits[3])
                                      )
  }
  ggplot(df, aes(fill = var), color = "White") +
    geom_sf() +
    coord_sf() +  
    fill_scale + 
    theme(legend.title = element_blank()) + 
    xlim(-87.85, -87.525) + ylim(41.65, 42.01)#+
   # ggtitle(title) + 
    #labs(subtitle ="Chicago Public Elementary School Districts (2019)",
     #    caption = "Data Sources: 2010 US Census; IL Board of Education")
} 


grid_arrange_shared_legend(
plot.map(elem.df.2009$frac, option = "viridis", direction=1, df=elem.df.2009) + ggtitle("2009"),
plot.map(elem.df$frac, option = "viridis", direction=1) + ggtitle("2019"),
ncol = 2)
```


## 4.3 Measuring Income Homogeneity

Creating a metric for income homogeneity in a school boundary posed two significant challenges: approximating a continuous distribution from discrete, binned data; and defining a measure of disparity within this approximated distribution.

I use income inequality to measure income homogeneity. Calcualating income inequality requires continuous income data. In order to transform the binned data into a continuous distribution, I use the \verb!fitdistrplus! R package, which allows a user to fit a univariate distribution to "censored" data. The package's relevant function uses the Nelder-Mead method to optimize the distributions' parameters for maximum log-likelihood given the binned data (RDocumentation, 2021). I fit a gamma distribution, since it is a relatively flexible distribution that begins at zero.  

Figure 3 demonstrates this process for a single school. Note that the bin widths are uneven, and the rightmost bin has no upper bound. The overlaid lines represent interpolated continuous distributions.

```{r, echo=F, fig.cap = "Louisa May Alcott Elementary School's neighborhood income distribution overlaid with interpolated gamma and log-normal distributions", fig.height = 3, fig.width = 6, fig.align = "center"}

x = 309 #alcott

#elem.df.2009$school_nm[x]

df = elem.df.2009[x,]
#income_dist = function(df, distr) {
  total = df$total.income
  left = c(rep(0, round(df$income.10k * total)), 
           rep(10, round(df$income.15k * total)), 
           rep(15, round(df$income.20k * total)), 
           rep(20, round(df$income.25k * total)),
           rep(25, round(df$income.30k * total)), 
           rep(30, round(df$income.35k * total)),
           rep(35, round(df$income.40k * total)), 
           rep(40, round(df$income.50k * total)),
           rep(50, round(df$income.60k * total)), 
           rep(60, round(df$income.75k * total)), 
           rep(75, round(df$income.100k * total)),
           rep(100, round(df$income.125k * total)),
           rep(125, round(df$income.150k * total)),
           rep(150, round(df$income.200k * total)),
           rep(200, round(df$income.more * total)))
  right = c(rep(10, round(df$income.10k * total)), 
            rep(15, round(df$income.15k * total)), 
            rep(20, round(df$income.20k * total)), 
            rep(25, round(df$income.25k * total)),
            rep(30, round(df$income.30k * total)), 
            rep(35, round(df$income.35k * total)),
            rep(40, round(df$income.40k * total)), 
            rep(50, round(df$income.50k * total)),
            rep(60, round(df$income.60k * total)), 
            rep(75, round(df$income.75k * total)), 
            rep(100, round(df$income.100k * total)),
            rep(125, round(df$income.125k * total)),
            rep(150, round(df$income.150k * total)),
            rep(200, round(df$income.200k * total)),
            rep(NA, round(df$income.more * total)))
  
  bins = data.frame("left" = left, "right" = right)
  fitted_distr <- fitdistcens(bins, distr="lnorm")
  fitted_distr_gamma <- fitdistcens(bins, distr="gamma")

#  return(fitted_distr)}
#fitted_distr = income_dist(elem.df.2009[1,], "lnorm")

counts = table(bins)
col="gray"
lefts =  as.numeric(levels(factor(bins$left)))
rights = c(as.numeric(levels(factor(bins$right))), 300)
heights = c(diag(counts), dim(bins)[1] - sum(counts)) 
weighted.heights = heights / (rights - lefts)
area = sum((rights - lefts) * weighted.heights)

ggplot() +
  geom_rect(aes(xmin = lefts, xmax=rights, ymin=rep(0,15), ymax=weighted.heights/area), color=col) + 
  #geom_density(aes(bins$left), col="green") +
  stat_function(fun = dlnorm, args = fitted_distr$estimate, aes(color = "blue")) +
  stat_function(fun = dgamma, args = fitted_distr_gamma$estimate, aes(color = "red")) + 
  xlim(c(0, 300)) +
  labs(xtitle = "Income (Thousands of 2009 USD)") + 
  scale_colour_manual("Distribution ", values = c("red", "blue"), labels= c("Gamma", "Log-Normal"))
```

Once I had the continuous distribution, I used the Gini coefficient as a metric for inequality. The Gini coefficient measures half the relative mean absolute difference between every two values in a dataset, which is the average pairwise distance between sets of two points, divided by the overall mean. The denominator for the mean absolute difference is $n^2$ because there are $n^2$ pairs of values with resampling. Thus:

\begin{equation}
Gini = \frac{1}{2} \cdot \frac{\text{mean difference}}{\text{arithmetic mean}} = 
\frac{\sum^n_{i=1} \sum^n_{j=1}  x_i - x_j }{2n^2 \bar{x}}
\end{equation}

Equation 4 also has a graphical equivalent in the Lorenz Curve. The Lorenz Curve shows cumulative income share of total income on the y-axis that is held by the poorest x percent of the population. A perfectly equal society would follow the line $y=x$, where, for instance, the poorest 80% of the population holds 80% of the total income. The Gini coefficient equals the area between a dataset's Lorenz curve and the line of equality (the blue area in Figure 4) divided by the total area under the line of equality (the blue and green areas together). A perfectly equal society has a Gini coefficient of 0, and a perfectly unequal society, where one individual holds all the income, has a Gini coefficient of 1 (U.S. Census Bureau, 2021).

```{r echo=FALSE, message=F, warning=F, fig.cap = "Lorenz Curve and Gini Coefficient. The Gini coefficient equals the area between a dataset's Lorenz curve and the line of equality (the blue area) divided by the total area under the line of equality (the blue and green areas together).", fig.height = 3, fig.width = 5, fig.align = "center"}

ggplot() +
  geom_area(data=data.frame("Population"=c(0,1), "Income"=c(0,1)), aes(x=Population, y=Income), fill="forestgreen") +
  stat_lorenz(data = sample, aes(income), col="blue", geom="polygon", fill="blue") + 
  stat_lorenz(data = sample, aes(income), col="yellow", geom="line")
```

## 4.4 Measuring Disparities in Student Outcomes

### 4.1 Comparing Metrics

Unfortunately, the most granular standardized testing data I could analyze was also binned data. I use math and English language arts (ELA) test scores from third and fifth grade students. The scores are binned by proficiency level. There were four levels before 2014, and there have been five levels since. The levels do not have equal bin size. I consider several metrics to quantify the spread or disparity in test scores:

1. I assign each proficiency level a value between 1 and 5 (and 1 to 4 for 2009 data). Then, I directly calculate the standard deviation of this set of integers. Since these values are really ordinal data and since the bins are not equal sizes for these levels, this is a fairly crude method.

2. I use a similar method to the income level data to generate a maximum likelihood continuous gamma distribution from the discrete, binned data for each school, subject, grade, and year. I then calculate the standard deviation of the continuous distribution. 

3. I calculate a chi-squared statistic for the distribution of proficiency levels, using the overall system-wide proficiency level proportions as the null distributions for each grade, year, and test subject. This metric essentially measures the deviation from the average distribution of proficiency levels.

I ultimately chose to use the chi-squared statistic as a metric for score disparities. Since the proficiency level data is ordinal and non-continuous, taking the standard deviation directly is not a particularly informative metric. The interpolated gamma distribution is similarly uninformative because the limited number of options (four proficiency levels in 2009 and five in 2019) provides too little information for a smooth distribution. Unlike the first two metrics, the chi-squared statistic is designed to compare distributions across categorical data. 

Thus, I use the chi-squared statistic, calculated using the citywide average proficiency level distribution as the null distribution. In short, this chi-squared statistic quantifies how dissimilar a school's proficiency level distribution is from the citywide average distribution. As illustrated in Figure 5, the chi-squared statistic's distribution is approximately log-normal, so my model will use the log of the chi-squared statistic as the response variable. 
\  

```{r, echo=F, message=F, warning=F, fig.cap = "Density plots for response variables measuring spread of student scores" }

grid.arrange(

ggplot(data = elem.df) + 
  geom_density(aes(ela.grade3.sd, col="Grade 3 ELA")) + 
  geom_density(aes((math.grade3.sd), col = "Grade 3 Math")) + 
  geom_density(aes((ela.grade5.sd), col = "Grade 5 ELA"))+
  geom_density(aes((math.grade5.sd), col = "Grade 5 Math")) + 
  ggtitle("Density of sds"),

ggplot(data = elem.df) + 
  geom_density(aes(ela.grade3.gamma.sd, col="Grade 3 ELA")) + 
  geom_density(aes((math.grade3.gamma.sd), col = "Grade 3 Math")) + 
  geom_density(aes((ela.grade5.gamma.sd), col = "Grade 5 ELA"))+
  geom_density(aes((math.grade5.gamma.sd), col = "Grade 5 Math")) + 
  xlim(c(0, 2000)) + 
  ggtitle("Density of Gamma sds"),

ggplot(data = elem.df) + 
  geom_density(aes((ela.grade3.chisq), col="Grade 3 ELA")) + 
  geom_density(aes((math.grade3.chisq), col = "Grade 3 Math")) + 
  geom_density(aes((ela.grade5.chisq), col = "Grade 5 ELA"))+
  geom_density(aes((math.grade5.chisq), col = "Grade 5 Math")) + 
  ggtitle("Density of Chi-squared Stats"),
  
ggplot(data = elem.df) + 
  geom_density(aes(log(ela.grade3.chisq), col="Grade 3 ELA")) + 
  geom_density(aes(log(math.grade3.chisq), col = "Grade 3 Math")) + 
  geom_density(aes(log(ela.grade5.chisq), col = "Grade 5 ELA"))+
  geom_density(aes(log(math.grade5.chisq), col = "Grade 5 Math")) + 
  ggtitle("Log Density of Chi-squared Stats"),
nrow = 2)
```

### 4.4.2 Understanding the Chi-Squared Statistic

The chi-squared metric captures the level of dissimilarity from the citywide average. Figure 6 illustrates two schools' distributions and their respective chi-squared statistics.
\  

```{r, echo=F, message=F, warning=F, fig.cap = "Sample distributions and their chi-squared statistics for two schools. The chi-squared statistic measures dissimilarity to the null distribution."}
scoresa = data.frame("level" = 1:5,
                    "prop"  = c(mean(elem.df$All.students.IAR.ELA.Level.1...Grade.3, na.rm=T),
                    mean(elem.df$All.students.IAR.ELA.Level.2...Grade.3, na.rm=T),
                    mean(elem.df$All.students.IAR.ELA.Level.3...Grade.3, na.rm=T),
                    mean(elem.df$All.students.IAR.ELA.Level.4...Grade.3, na.rm=T),
                    mean(elem.df$All.students.IAR.ELA.Level.5...Grade.3, na.rm=T))
)

x=256
scoresb = data.frame("level" = 1:5,
                    "prop"  = c(elem.df$All.students.IAR.ELA.Level.1...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.2...Grade.3[x],
                                elem.df$All.students.IAR.ELA.Level.3...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.4...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.5...Grade.3[x])
)


x=353

scoresc = data.frame("level" = 1:5,
                    "prop"  = c(elem.df$All.students.IAR.ELA.Level.1...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.2...Grade.3[x],
                                elem.df$All.students.IAR.ELA.Level.3...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.4...Grade.3[x], 
                                elem.df$All.students.IAR.ELA.Level.5...Grade.3[x])
)

grid.arrange(

ggplot(data=scoresb, aes(x = level, y = prop)) + 
  geom_bar(stat="identity", fill = "purple") +
  ggtitle("Bass Elem: Chi-sq = 81.2"),

ggplot(data=scoresc, aes(x = level, y = prop)) + 
  geom_bar(stat="identity", fill = "purple") +
  ggtitle("Ogden Elem: Chi-sq = 5.8"),

ggplot(data=scoresa, aes(x = level, y = prop)) + 
  geom_bar(stat="identity", fill = "darkgray") +
  ggtitle("Null Distribution"),

nrow = 2)

```

\newpage
### 4.4.3 Limitations of the Chi-Squared Statistic

One weakness of using the chi-squared statistic as the response variable is that it cannot distinguish between proficiency level distributions that are equally different from the null distribution but indicate different levels of score spread. For instance, consider the following hypothetical sets of students in a district where the null score distribution is equal probabilities for each proficiency level:


```{r, include=F}
ex1 = c(rep(1, 1), rep(2, 3), rep(3, 7), rep(4, 3), rep(5, 1))
ex2 = c(rep(1, 1), rep(2, 1), rep(3, 3), rep(4, 3), rep(5, 7))
chisq.test(table(ex1), p=rep(0.2, 5))$statistic
chisq.test(table(ex2), p=rep(0.2, 5))$statistic
sd(ex1)
sd(ex2)
```

\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c c c c c }
\hline
 & \# at Level 1 & \# at Level 2 & \# at Level 3 & \# at Level 4 & \# at Level 5 & $\chi^2$ & SD & Mean \\
 \hline
School A & 1 & 2 & 3 & 4 & 5 & `r round(chisq.test(table(ex1), p=rep(0.2, 5))$statistic, 2)` & `r round(sd(ex1), 2)` & `r round(mean(ex1), 2)` \\
School B & 1 & 4 & 5 & 3 & 2 & `r round(chisq.test(table(ex2), p=rep(0.2, 5))$statistic, 2)` & `r round(sd(ex2), 2)` & `r round(mean(ex2), 2)` \\
\hline
\end{tabular}
\caption{Chi-squared Example}
\label{table:7}
\end{table}
\end{center}

Although the total number of students are the same, and the chi-squared statistic is the same, the distributions of proficiency levels are significantly different, and the standard deviations and means differ. Despite these limitations, I proceed cautiously with chi-squared as the response variable.

## 4.5 Measuring Spatial Auto-correlation

The extent of spatial auto-correlation is a key question for any spatio-temporal data. In this case, we ask: do schools that are geographically close perform similarly? Does this pattern remain when controlling for neighborhood characterstics such as race and income?

In order to answer these questions, I use Moran's I as a metric for the level of spatial auto-correlation. Moran's I quantifies the relationship between a single variable, $x$, with $n$ values, and pairwise geographic distances between locations $\{l_1, \dots, l_n\}$, which are incorporated in a distance weight matrix $\bf{W}$. Each entry $w_{ij}$ represents a spatial weight related to the distance between points $i$ and $j$. The diagonals on $\bf{W}$ are 0. For spatial weights, I use the inverse planar distance between a pair of school boundaries' centroids. 

\begin{equation}
\bf{W} = \begin{pmatrix}
0 & \dots & w_{1n} \\
\vdots & \ddots & \vdots\\
w_{n1} & \dots & 0\\
\end{pmatrix}, \text{  }
w_{ij} = \frac{1}{dist(centroid_i, centroid_j)}
\end{equation}


Then, I use $\bf{W}$ to calculate Moran's I:

\begin{equation}
I = \big(\frac{n}{\sum_i\sum_j w_{ij}}\big)
\frac{\sum_i\sum_j w_{ij}(x_i - \bar{x})(x_j - \bar{x})}{\sum_i (x_i-\bar{x})^2}
\end{equation}



\newpage
\begin{center}
\Large{\textsc{5. Descriptive Statistics}}
\end{center}

## 5.1 Neighborhood Demographics

```{r, include=F}
elem.df$school.black %>% sum -> total.black.students
elem.df$school.black[elem.df$prop.school.black > 75] %>% sum / total.black.students

(elem.df$school.black %>% sum(na.rm = T)) / (elem.df$total.students %>% sum(na.rm = T))

(elem.df$largest.group > 90) %>% mean
```

As mentioned in the introduction, Chicago has a legacy of dramatic residential segregation. Historically, the richest and Whitest neighborhoods concentrate in the northern part of the city. These residental patterns have not changed dramatically over time. Figures 7 and 8 illustrate the median income and predominant racial or ethnic group in each elementary school boundary. 


```{r, echo=F, fig.cap = "Median household income (in thousands of 2019 U.S. dollars) by elementary school boundary."}
# Creating a function to plot district-level data


grid_arrange_shared_legend(
  plot.map(df=elem.df.2009,var = 1.2*elem.df.2009$med.income, option="inferno", direction=-1) + ggtitle("2009"),
  plot.map(var = elem.df$med.income, option="inferno", direction=-1) + ggtitle("2019"),
ncol=2)

```


```{r, echo=F, fig.cap = "Largest racial/ethnic group by elementary school boundary. The largest group is defined as the most common racial/ethnic category for residents within a school boundary."}

grid_arrange_shared_legend(
  ggplot() +
  xlim(-87.85, -87.525) + ylim(41.65, 42.01) +
  geom_sf(data = elem.df.2009, aes(fill = most.common.group)) + ggtitle("2009"),
ggplot() +
  xlim(-87.85, -87.525) + ylim(41.65, 42.01) +
  geom_sf(data = elem.df, aes(fill = most.common.group)) + ggtitle("2019"),
ncol=2)

```

```{r, include=F}
mean(elem.df$prop.af.am[elem.df$most.common.group == "Black"]) -> x
```


\newpage
## 5.2 School Demographics

As a result of the stark residential segregation by race (pictured in the previous section), each neighborhood is highly homogeneous. For instance, the typical predominantly Black neighborhood is `r round(100*x,1)`\% Black. This neighborhood homogeneity spills over into the schools. In more than half of public elementary schools in Chicago, 90% of the student body identifies with the same racial/ethnic group. This effect is particularly dramatic for Black students. Although Black students only comprised about 34% of the CPS student body in 2019, more than three quarters of Black students attended a school that was at least 75% Black.

```{r, include=F}
elem.df.2009$largest.group[elem.df.2009$largest.group == 0] = NA
elem.df$largest.group[elem.df$largest.group == 0] = NA
```

\  

```{r, echo=F, warning=F, fig.cap = "Proportion of students who identify with the predominant racial or ethnic group in the school (2019). This is a measure of racial homogeneity that corresponds to equation 3 in section 4.2. Higher values indicate greater homogeneity."}

elem.df$largest.group[elem.df$largest.group == 0] = NA

#grid_arrange_shared_legend(
#lot.map(elem.df.2009$largest.group, "Highest Proportion of Same-Race Students", option = "plasma", direction=-1, df=elem.df.2009) + ggtitle("2009"),
plot.map(elem.df$largest.group, "Highest Proportion of Same-Race Students", option = "plasma", direction=-1, df=elem.df) 
#+ ggtitle("2019"), ncol=2)
```

Figure 9 illustrates the magnitude of this homogeneity. The map shows the proportion of students in each school who identify with the school's predominant racial or ethnic group. For instance, a value of 0.90 on the plot represents a school where 90% of the students identify as the same race. This metric is exactly the "largest group" metric described in equation 2 in section 4.2. The most diverse school had a "largest group" metric of `r round(min(elem.df$largest.group, na.rm=T),3)*100`\% in 2019, and the least diverse schools had a metric of 100\%, with complete racial homogeneity. In 2019, `r length(elem.df$school_nm[elem.df$largest.group > 0.95])` schools had a largest group metric of more than 95\%.

```{r, include=F}
sum(elem.df$white)/sum(elem.df$all.races)
sum(elem.df$school.white)/sum(elem.df$total.students, na.rm=T)
```

Generally, school demographics closely follow the demographics of a boundary's district, but there are some exceptions. In the most recent data, 31.73% of Chicago residents were White, but only 12.5% of Chicago public elementary school students were White. This disparity could reflects both age differences (if more White Chicagoans are not school age) and any families who opt out of the public school system (and into private schools or homeschooling).

```{r, echo=F, message=F, warning=F, fig.cap = "Proportion of White residents versus White students in 2019. In the most recent data, 31.73% of Chicago residents were White, but only 12.5% of Chicago public elementary school students were White."}
grid_arrange_shared_legend(
plot.map(elem.df$prop.white, "Proportion of White Residents", option="inferno", direction=-1) + ggtitle("White Residents"),
plot.map(elem.df$prop.school.white/100, "Proportion of White Students", option="inferno", direction=-1, limits=c(0,1))+ ggtitle("White Students"), nrow=1)

read.csv("~/Desktop/Thesis/School performance data/2009/testdata_processed.txt") -> testdata2009

```

To determine the driving cause of the White student "opt-out," I calculate the "opt-out" probability for a White student. This metric is equivalent to the proportion of White residents in the neighborhood minus the proportion of White students over the proportion of White residents in the neighborhood. Although this metric is not a direct probability measurement, it meaningfully measures the relative gap between school and neighborhood demographics. 

\begin{equation}
Pr(opt\ out) = \frac{\frac{white.residents}{total.residents} - \frac{white.students}{total.students}}{\frac{white.residents}{total.residents}}
\end{equation}

Interestingly, neighborhood-level median income is not a significant predictor of White opt-out probability after accounting for the proportion of White residents in a neighborhood. This suggests contradicting forces at play. Individuals in poorer neighborhoods may opt out of local elementary schools if they perceive them to be lower quality. At the same time, families in wealthier neighborhoods may opt-out of public schools (even if they are well-resourced) because private school tuition poses less of a financial burden. 

```{r, include=F}
lm(data = elem.df, -white.prop.difference.percent ~ prop.white + med.income) %>% summary
```

## 5.3 School Outcomes

I measure school outcomes at the grade, subject, year, and school level. As mentioned earlier, these data are only available as the proportion of students at each the proficiency level. The data come from third and fifth grade standardized test scores, collected at `r dim(elem.df)[1]` elementary schools serving a total of 192,617 students in 2019. In 2009, the data comes from `r dim(elem.df.2009)[1]` schools serving 165,079 students.

```{r}
concat = function(list){
  #Function to concatenate strings
  if(length(list) == 1){
    return (list[1])
  }
  return (paste(list[1], concat(list[2:length(list)]), sep=""))
}

test_category = function(subject, grade, level) {
  return( paste( paste( paste("All.students.IAR.", subject, sep=""),
                 paste("Level", level, sep="."), sep = "." ),
                 paste("Grade", grade, sep="."), sep ="...") )
}

test_category_2009 = function(subject, grade, level) {
  return( concat(c("Grade",grade,".", subject, ".", "Level", level)) )
}

test.prop = function(grade, subject, year, level){
  if (year == 2009){
    df = data.frame(elem.df.2009)
    return(round(sum(df[,test_category_2009(subject, grade, level)] * df$total.students/100, na.rm=T)/sum(df$total.students, na.rm=T),2))
  } else if(year == 2019){
    if (subject == "Math"){
      subject = "Mathematics"
    }
    df = data.frame(elem.df)
    return(round(sum(df[,test_category(subject, grade, level)] * df$total.students/100, na.rm=T)/sum(df$total.students, na.rm=T),2))
  }
}


```

\singlespacing
\begin{center}
\begin{table}[H]
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
 Variable & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math  \\ 
\\
 \hline
 2009
 \\
 \hline
 \\
 Proportion at Level 1 & `r i = 1` `r test.prop(3, "ELA", 2009, i)` & `r test.prop(3, "Math", 2009, i)` & `r test.prop(5, "ELA", 2009, i)` & `r test.prop(5, "Math", 2009, i)`\\
 Proportion at Level 2 & `r i = 2` `r test.prop(3, "ELA", 2009, i)` & `r test.prop(3, "Math", 2009, i)` & `r test.prop(5, "ELA", 2009, i)` & `r test.prop(5, "Math", 2009, i)`\\
 Proportion at Level 3& `r i = 3` `r test.prop(3, "ELA", 2009, i)` & `r test.prop(3, "Math", 2009, i)` & `r test.prop(5, "ELA", 2009, i)` & `r test.prop(5, "Math", 2009, i)`\\
 Proportion at Level 4 & `r i = 4` `r test.prop(3, "ELA", 2009, i)` & `r test.prop(3, "Math", 2009, i)` & `r test.prop(5, "ELA", 2009, i)` & `r test.prop(5, "Math", 2009, i)`\\
 
 \\
 \hline
 2019
 \\
 \hline
 \\
  Proportion at Level 1 & `r i = 1` `r test.prop(3, "ELA", 2019, i)` & `r test.prop(3, "Math", 2019, i)` & `r test.prop(5, "ELA", 2019, i)` & `r test.prop(5, "Math", 2019, i)`\\
 
  Proportion at Level 2 & `r i = 2` `r test.prop(3, "ELA", 2019, i)` & `r test.prop(3, "Math", 2019, i)` & `r test.prop(5, "ELA", 2019, i)` & `r test.prop(5, "Math", 2019, i)`\\
 
  Proportion at Level 3 & `r i = 3` `r test.prop(3, "ELA", 2019, i)` & `r test.prop(3, "Math", 2019, i)` & `r test.prop(5, "ELA", 2019, i)` & `r test.prop(5, "Math", 2019, i)`\\
 
  Proportion at Level 4 & `r i = 4` `r test.prop(3, "ELA", 2019, i)` & `r test.prop(3, "Math", 2019, i)` & `r test.prop(5, "ELA", 2019, i)` & `r test.prop(5, "Math", 2019, i)`\\
  
  Proportion at Level 5 & `r i = 5` `r test.prop(3, "ELA", 2019, i)` & `r test.prop(3, "Math", 2019, i)` & `r test.prop(5, "ELA", 2019, i)` & `r test.prop(5, "Math", 2019, i)`\\
 \\
 \hline
 \hline
\end{tabular}
\caption{City-wide proficiency levels by year, grade, and subject. }
\label{table:4}
\end{table}
\end{center}

\doublespacing
These proficiency levels vary dramatically by school. Figure 10 shows density plots for 3rd grade math and ELA scores in 2009 and 2019. Each colored line on the plot represents a proficiency level. The density is across all schools, so the curve represents the density (y-axis) of schools having a given proportion of students (x-axis) testing at the line's proficiency level. For instance, the green line on the top, right plot shows that most schools have around 50% of its students testing at level 3 proficiency for math. The highest proficiency levels (the blue level 4 line for the 2009, and the purple level 5 line for 2019) are heavily right-skewed, which illustrates that few schools have many high preforming students. 


```{r, echo=F, message=F, warning=F, fig.cap = "Density curves for proficiency levels. Each colored line on the plot represents a proficiency level. The density is across all schools, so the curve represents the density (y-axis) of schools having a given proportion of students (x-axis) testing at the line's proficiency level. For instance, the green line on the top, right plot shows that most schools have around 50% of its students testing at level 3 proficiency for math."}

colors <- c("Level 1" = "red", "Level 2" = "orange", "Level 3" = "green", "Level 4" = "blue", "Level 5" = "purple")

grid.arrange(

ggplot() + 
  geom_density(data = testdata2009, aes(Grade3.ELA.Level4, col="Level 4")) +
  geom_density(data = testdata2009, aes(Grade3.ELA.Level3, col="Level 3")) +
  geom_density(data = testdata2009, aes(Grade3.ELA.Level2, col="Level 2")) + 
  geom_density(data = testdata2009, aes(Grade3.ELA.Level1, col="Level 1")) + 
  labs(x = "Percent",
       y = "Density",
       color = "Legend") +
  scale_color_manual(values = colors) + 
  ggtitle("Proficiency Levels, ELA, 2009"),

ggplot() + 
  geom_density(data = testdata2009, aes(Grade3.Math.Level4, col="Level 4")) +
  geom_density(data = testdata2009, aes(Grade3.Math.Level3, col="Level 3")) +
  geom_density(data = testdata2009, aes(Grade3.Math.Level2, col="Level 2")) + 
  geom_density(data = testdata2009, aes(Grade3.Math.Level1, col="Level 1")) + 
  labs(x = "Percent",
       y = "Density",
       color = "Legend") +
  scale_color_manual(values = colors) + 
  ggtitle("Proficiency Levels, Math, 2009"), 

ggplot() + 
  geom_density(data = elem.df, aes(All.students.IAR.ELA.Level.5...Grade.3, col="Level 5")) + 
  geom_density(data = elem.df, aes(All.students.IAR.ELA.Level.4...Grade.3, col="Level 4")) +
  geom_density(data = elem.df, aes(All.students.IAR.ELA.Level.3...Grade.3, col="Level 3")) +
  geom_density(data = elem.df, aes(All.students.IAR.ELA.Level.2...Grade.3, col="Level 2")) + 
  geom_density(data = elem.df, aes(All.students.IAR.ELA.Level.1...Grade.3, col="Level 1")) + 
  labs(x = "Percent",
       y = "Density",
       color = "Legend") +
  scale_color_manual(values = colors) + 
  ggtitle("Proficiency Levels, ELA, 2019"),

ggplot() + 
  geom_density(data = elem.df, aes(All.students.IAR.Mathematics.Level.5...Grade.3, col="Level 5")) + 
  geom_density(data = elem.df, aes(All.students.IAR.Mathematics.Level.4...Grade.3, col="Level 4")) +
  geom_density(data = elem.df, aes(All.students.IAR.Mathematics.Level.3...Grade.3, col="Level 3")) +
  geom_density(data = elem.df, aes(All.students.IAR.Mathematics.Level.2...Grade.3, col="Level 2")) + 
  geom_density(data = elem.df, aes(All.students.IAR.Mathematics.Level.1...Grade.3, col="Level 1")) + 
  labs(x = "Percent",
       y = "Density",
       color = "Legend") +
  scale_color_manual(values = colors) + 
  ggtitle("Proficiency Levels, Math, 2019"),
nrow =2)

```


\newpage
## 5.4 Spatial Autocorrelation

```{r, include=F}
inv.dists = 1 / st_distance(st_centroid(elem.df$geometry[-c(37,151,295)]))
diag(inv.dists) = 0
units(inv.dists) <- NULL

# Yes, there is spatial autocorrelation
Moran.I(elem.df$ela.grade3.chisq[-c(37,151,295)], inv.dists, na.rm=T) -> moran.ela.3
Moran.I(elem.df$math.grade3.chisq[-c(37,151,295)], inv.dists, na.rm=T) -> moran.math.3
Moran.I(elem.df$ela.grade5.chisq[-c(37,151,295)], inv.dists, na.rm=T) -> moran.ela.5
Moran.I(elem.df$math.grade5.chisq[-c(37,151,295)], inv.dists, na.rm=T) -> moran.math.5
```

I use Moran's I (equation 6) to calculate the level of spatial auto-correlation for our response variables (chi-squared statistics) of standardized test scores. Tests on both grade levels and subjects suggest a significant and positive spatial auto-correlation. This means that schools that are near each other tend to have similar proficiency level disparities. 

\singlespacing
\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
  & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math  \\ 
\\
 \hline \\
  Expected & `r moran.ela.3$expected` & `r moran.math.3$expected` & `r moran.ela.5$expected`& `r moran.math.5$expected` \\
  Observed  & `r moran.ela.3$observed` & `r moran.math.3$observed` & `r moran.ela.5$observed`& `r moran.math.5$observed` \\
  Standard Deviation & `r moran.ela.3$sd` & `r moran.math.3$sd` & `r moran.ela.5$sd`& `r moran.math.5$sd` \\
  P-value & `r moran.ela.3$p.value` & `r moran.math.3$p.value` & `r moran.ela.5$p.value`& `r moran.math.5$p.value` \\
 \hline
 \hline
\end{tabular}
\caption{Assessing Spatial Auto-Correlation Using Moran's I, 2019}
\label{table:5}
\end{table}
\end{center}

\doublespacing
This level of auto-correlation is unsurprising given the level of income and racial segregation in the city and the strong correlation of income and race with test results. Note that median household income and race both have strong spatial auto-correlations. 

```{r, include=F}

# Yes, there is spatial autocorrelation
Moran.I(elem.df$med.income[-c(37,151,295)], inv.dists, na.rm=T) -> moran.ela.3
Moran.I(elem.df$prop.school.white[-c(37,151,295)], inv.dists, na.rm=T) -> moran.math.3
Moran.I(elem.df$prop.school.black[-c(37,151,295)], inv.dists, na.rm=T) -> moran.ela.5

```

\singlespacing
\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c }
\hline
\hline
  \\
  & Median Household Income & Prop White Students & Prop Black Students \\ 
\\
\hline \\
  Expected & `r moran.ela.3$expected` & `r moran.math.3$expected` & `r moran.ela.5$expected` \\
  Observed  & `r moran.ela.3$observed` & `r moran.math.3$observed` & `r moran.ela.5$observed` \\
  Standard Deviation & `r moran.ela.3$sd` & `r moran.math.3$sd` & `r moran.ela.5$sd` \\
  P-value & `r moran.ela.3$p.value` & `r moran.math.3$p.value` & `r moran.ela.5$p.value` \\
 \hline
 \hline
\end{tabular}
\caption{Assessing Spatial Auto-Correlation Using Moran's I, Demographics, 2019}
\label{table:6}
\end{table}
\end{center}

\doublespacing
 I test whether there is still spatial auto-correlation after controlling for race and income by testing Moran's I for the residuals on a regression that includes race and income. 

\begin{equation}
resid = \chi^2 - (b_0 + b_1(income) + b_2(prop White) + b_3(prop White \times income))
\end{equation}

```{r, include = F}
lm.control = lm(data=elem.df, ela.grade3.chisq ~ med.income + prop.school.white + prop.school.white*med.income) 
summary(lm.control)
#+ prop.school.black + prop.school.black*prop.school.white)
Moran.I(as.vector((residuals(lm.control))), inv.dists[-231,][,-231], na.rm=T) -> moran.control
moran.control
```

```{r, echo=F, fig.cap = "Plot of residuals for the chi-squared statistic of 3rd grade ELA proficiency levels, accounting for race and income (equation 7)", fig.align='center', fig.width = 5}
elem.df$residuals = NA
elem.df$residuals[-c(37,151,231,295)] = residuals(lm.control)
outliers.moran.ix = c(126, 208, 239, 297)
plot.map(elem.df$residuals, "Residuals", option="magma", direction=-1)
```

Using the residuals from the regression equation above,  I get a p-value of `r round(moran.control$p.value, 2)` from calculating Moran's I. This suggests that race and income account for most of the spatial auto-correlation.  I will discuss the outliers in this plot in section 6.3.

## 5.5 Variable Relationships

In order to investigate the effect of racial and income homogeneity on elementary school performance,  I must isolate the effects of these variables by controlling for potentially confounding variables or collinearity. 

First, I consider the relationships between various explanatory variables in Figure 13. Many of these relationships are not surprising. For instance, the proportion of White residents in a neighborhood is strongly correlated with the proportion of White students, with a correlation coefficient of `r round(cor(na.omit(elem.df$prop.school.white),na.omit(elem.df$prop.white)), 2)`. 


```{r, echo=F, message=F, warning=F, fig.cap = "Investigating relationships between predictor variables"} 
library(corrplot)
M = cor(na.omit(st_drop_geometry(elem.df))[,c("gamma.gini", 
                   "largest.group",
                   "frac",
                   "prop.school.black",
                   "prop.school.white",
                   "prop.school.hispanic",
                   "prop.school.lowincome",
                   "prop.school.EL",
                   "prop.white",
                   "prop.af.am",
                   "prop.hispanic",
                   
                   "med.income")])

rownames(M) = c("Gini", 
                   "Largest group",
                   "Fractionalization",
                   "Prop school Black",
                   "Prop school White",
                   "Prop school Hispanic",
                   "Prop school low income",
                   "Prop school EL",
                   "Prop neighborhood Black",
                   "Prop neighborhood White",
                   "Prop neighborhood Hispanic",
                   
                   "Median household income")
colnames(M) = rownames(M)

corrplot(M, tl.col = "Black")
```


There are several other relationships of note. The proportion of White students and the level of median household income are both negatively correlated with the proportion of low income students in a school, while income is strongly and positively correlated with the proportion of White students in a school. This in unsurprising in a city where White residents have significantly higher income than residents of color. The correlation coefficient for the relationship between proportion of White residents and median household income is `r  round(cor(na.omit(elem.df$prop.school.white),na.omit(elem.df$med.income)), 2)`.

Also noticeably, the proportion of White residents has a strong negative association with the size of the largest same-race group in a school. This association is consistent with the fact that only `r sum(elem.df$prop.school.white > .5, na.rm=T)` schools are more than 50% White. In general, schools that have more White students are less homogeneous. Also unsurprisingly, the largest group metric is strongly correlated with the fractionalization metric.

Because of the level of residential segregation by race, there is strong negative association between the proportion of Hispanic and Black students, with a correlation coefficient of `r  round(cor(na.omit(elem.df$prop.school.black),na.omit(elem.df$prop.school.hispanic)), 2)`. Schools with more Hispanic students tend to have more English learners. Thus, the association between the proportion of Hispanic students and English learners is large and positive, while the association between the proportion of Black students and English learners is large and negative. 
  

```{r, echo=F, message=F, warning=F, fig.cap="Investigating relationships between response variables"}

M = cor(na.omit(st_drop_geometry(elem.df))[,c(
                    "ela.grade3.mean",
                    "math.grade3.mean",
                    "ela.grade5.mean",
                    "math.grade5.mean",
                   "ela.grade3.chisq",
                   "math.grade3.chisq",
                   "math.grade5.chisq",
                   "ela.grade5.chisq"
              )])

rownames(M) = colnames(M) = c("Mean 3rd grade ELA",
                              "Mean 3rd grade Math",
                              "Mean 5th grade ELA",
                              "Mean 5th grade Math",
                   "Chi-squared, 3rd grade ELA",
                   "Chi-squared, 3rd grade Math",
                   "Chi-squared, 5th grade ELA",
                   "Chi-squared, 5th grade Math"
              )

corrplot(M, tl.col = "Black")
```

Figure 14 illustrates the relationships between response variables. Interestingly, the chi-squared statistic is not strongly associated with the mean proficiency level for any grade or subject. However, the means for each grade and subject are positively associated with each other, as are the chi-squared statistics for each grade and subject. 

\newpage
\begin{center}
\Large{\textsc{6. Analysis}}
\end{center}


```{r, include=F}
#elem.df$prop.school.black = elem.df$prop.school.black/100
#elem.df$prop.school.lowincome = elem.df$prop.school.lowincome/100
#elem.df$med.income = elem.df$med.income/1000
#elem.df$largest.group = elem.df$largest.group/100

outliers.moran.ix = c(126, 208, 239, 297)
elem.df = elem.df[-outliers.moran.ix,]

final.model.3.ela = lm(formula = log(ela.grade3.chisq) ~ 
                   gamma.gini + 
                   frac +  
                   #prop.school.white + 
                   prop.white +
                   med.income + 
                   prop.school.black +
                   prop.school.hispanic + 
                   prop.school.lowincome + 
                   prop.school.black:prop.school.white + 
                   prop.school.black:prop.school.hispanic,
                 data = elem.df) 

final.model.3.math = update(final.model.3.ela, log(math.grade3.chisq) ~ .)

final.model.5.ela = update(final.model.3.ela, log(ela.grade5.chisq) ~ .)

final.model.5.math = update(final.model.3.ela, log(math.grade5.chisq) ~ .)


star = function(var, i){
   if(p.values[i,var] < 0.01){
    return("***")
  }
  if(p.values[i,var] < 0.05){
    return("**")
  }
  if(p.values[i,var] < 0.1){
    return("*")
  }
}

```

```{r, include=F}
#elem.df.2009$prop.school.black = elem.df.2009$prop.school.black/100
#elem.df.2009$prop.school.lowincome = elem.df.2009$prop.school.lowincome/100
#elem.df.2009$med.income = elem.df.2009$med.income/1000
# elem.df.2009$largest.group = elem.df.2009$largest.group/100

ela.3.2009 = lm(formula = log(ela.grade3.chisq) ~ 
                   gamma.gini + 
                   frac +  
                   #prop.school.white + 
                   prop.white +
                   med.income + 
                   prop.school.black +
                   prop.school.hispanic + 
                   prop.school.lowincome + 
                   prop.school.black:prop.school.white + 
                   prop.school.black:prop.school.hispanic,
                 data = elem.df.2009) 


math.3.2009 = update(ela.3.2009, log(math.grade3.chisq) ~ .)

ela.5.2009 = update(ela.3.2009, log(ela.grade5.chisq) ~ .)

math.5.2009 = update(ela.3.2009, log(math.grade5.chisq) ~ .)



```

## 6.1 The Model

Finally,  I fit a linear regression to quantify the influence of income inequality and school homogeneity on disparities in test scores for school $s$ and year $t$. 

\begin{equation}
\begin{split}
{log(\chi^2)}_{st} = & b_0 + b_1 GINI_{st} + b_2 FRAC_{st} + \bf{\gamma B_{st}} + \bf{\lambda S_{st}} + \varepsilon \\
\end{split}
\end{equation}

GINI represents the gini coefficient, my metric for income homogeneity, and FRAC represents the fractionalization index, my metric for racial homogeneity. $\bf{B}_{st}$ is a vector of neighborhood level controls, including the proportion of White residents and the median household income in the neighborhood. Similarly, $\bf{S}_{st}$ is a vector of school level controls, including the proportion of Black, Hispanic, and low-income students, as well as the Black-White and Black-Hispanic student ratios.

## 6.2 Diagnostics

```{r, echo=F, warning=F, message=F, fig.cap="Diagnostic plots for a linear model of score disparities for 3rd grade ELA scores in 2019. The QQ-plot suggests normality for the residuals. Although there is some horizontal clustering of the residuals, there is no obvious vertical pattern."}
autoplot(final.model.3.ela)
```

These models generally satisfy the assumptions for linear regression. Figure 15 shows diagnostic plots for 3rd grade ELA scores. Although there is some horizontal clustering of the residuals, there is no obvious vertical pattern, and the QQ-plot suggests that the residuals are normally distributed. I did not display the diagnostic plots for other grades and subjects, but they similarly satisfy the conditions for linear regression. There are a few outliers, which  I address next.

\newpage
## 6.3 Outliers

```{r, include=F, message=F, warning=F}
lm.influence(final.model.3.ela)[[1]] -> hats
data.frame(elem.df)[which(hats > 0.1), ]
lm.influence(final.model.5.ela)[[1]] -> hats
data.frame(elem.df)[which(hats > 0.1), ]
lm.influence(final.model.3.math)[[1]] -> hats
data.frame(elem.df)[which(hats > 0.1), ]
lm.influence(final.model.5.math)[[1]] -> hats
data.frame(elem.df)[which(hats > 0.1), ]

data.frame(elem.df)[elem.df$ela.grade3.mean > 4.2,]
data.frame(elem.df)[elem.df$ela.grade3.mean < 1.8,]
```

```{r}
outliers.moran = c("PRITZKER", "EDGEBROOK", "RAVENSWOOD", "SKINNER", "LINCOLN")
outliers.moran.ix = c(126, 208, 239, 297)
outliers.leverage = c()

outliers.magnets = c("DUNNE" )
# Dunne?
# other charters?
# get opt out data??
```

```{r, include= F, fig.cap= "Residuals for 2019 model of 3rd grade ELA score spread"}
elem.df$residuals.3.ela = NA
residuals(final.model.3.ela) -> elem.df[-c(37,151,231,295),]$residuals.3.ela
elem.df$school_nm[elem.df$residuals.3.ela < -3]
# TARKINGTON
#elem.df$school_nm[elem.df$residuals.3.ela > 2]


high.out.of.district = c("SKINNER", "WARD, J", "BURR", "RAY", "OROZCO", 
                         "NATIONAL TEACHERS ACAD", "PULASKI", "CARNEGIE", "RAVENSWOOD",
                         "DIXON", "HAMILTON", "CHAPPELL", "PARKER", "BOND", "NEIL", 
                         "HARTE", "CHALMERS", "MELODY", "PRITZKER", "MCPHERSON", 
                         "PRESCOTT", "DVORAK TECH ACAD", "IRVING", "YATES",
                         "DIEGO", "JENNER", "GREELEY", "SHOESMITH", "TELPOCHCALLI",
                         "HERZL", "COLUMBUS", "BROWN, W", "JAHN", "KOZMINSKI",
                         "BEETHOVEN", "ATTUCKS", "GOETHE", "COLEMON")

very.high = c("SKINNER", "BURR", "OROZCO", 
                          "PULASKI", "CARNEGIE", "RAVENSWOOD",
                          "HAMILTON", "PARKER", "NEIL", 
                         "HARTE", "CHALMERS", "PRITZKER", "MCPHERSON", 
                         "PRESCOTT", "IRVING", 
                          "GREELEY",  "TELPOCHCALLI",
                         "COLUMBUS", "JAHN", "KOZMINSKI",
                         "BEETHOVEN", "ATTUCKS", "GOETHE", "COLEMON")

```


```{r, include =F}
ela.3.2009 = update(ela.3.2009, data = elem.df.2009[-!(elem.df$school_nm %in% very.high),], . ~ .)
math.3.2009 = update(math.3.2009, data = elem.df.2009[-!(elem.df$school_nm %in% very.high),], . ~ .)
ela.5.2009 = update(ela.5.2009, data = elem.df.2009[-!(elem.df$school_nm %in% very.high),], . ~ .)
math.5.2009 = update(math.5.2009, data = elem.df.2009[-!(elem.df$school_nm %in% very.high),], . ~ .)

coefs.2009 = round(data.frame("ela.3" = summary(ela.3.2009)$coefficients[,1],
                "math.3" = summary(math.3.2009)$coefficients[,1],
                "ela.5" = summary(ela.5.2009)$coefficients[,1],
                "math.5" = summary(math.5.2009)$coefficients[,1]),3)

se.2009 = round(data.frame("ela.3" = summary(ela.3.2009)$coefficients[,2],
                "math.3" = summary(math.3.2009)$coefficients[,2],
                "ela.5" = summary(ela.5.2009)$coefficients[,2],
                "math.5" = summary(math.5.2009)$coefficients[,2]),3)

p.values.2009 = data.frame("ela.3" = summary(ela.3.2009)$coefficients[,4],
                "math.3" = summary(math.3.2009)$coefficients[,4],
                "ela.5" = summary(ela.5.2009)$coefficients[,4],
                "math.5" = summary(math.5.2009)$coefficients[,4])

#vars = summary(ela.3.2009)$coefficients %>% rownames()
vars = c("Intercept",
         "Gini",
         "Fractionalization",
         "Proportion White Residents",
         "Median Household Income",
         "Proportion Black Students",
         "Proportion Hispanic Students",
         "Proportion Low Income Students",
         "Black-White Student Ratio",
         "Black-Hispanic Student Ratio")


final.model.3.ela = update(final.model.3.ela, data = elem.df[-!(elem.df$school_nm %in% very.high),], . ~ .)
final.model.3.math = update(final.model.3.math, data = elem.df[-!(elem.df$school_nm %in% very.high),], . ~ .)
final.model.5.ela = update(final.model.5.ela, data = elem.df[-!(elem.df$school_nm %in% very.high),], . ~ .)
final.model.5.math = update(final.model.5.math, data = elem.df[-!(elem.df$school_nm %in% very.high),], . ~ .)

se = round(data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,2],
                "math.3" = summary(final.model.3.math)$coefficients[,2],
                "ela.5" = summary(final.model.5.ela)$coefficients[,2],
                "math.5" = summary(final.model.5.math)$coefficients[,2]),3)

p.values = data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,4],
                "math.3" = summary(final.model.3.math)$coefficients[,4],
                "ela.5" = summary(final.model.5.ela)$coefficients[,4],
                "math.5" = summary(final.model.5.math)$coefficients[,4])
```

```{r}
#plot.map(elem.df$residuals.3.ela, "", option="magma", direction = -1)
```

My model links neighborhood and school characteristics, so the model expects a typical student to reside in the neighborhood their school serves. Although this assumption is broadly true, there are a few schools (including magnet schools) that pull students from across the city. I omit these schools from the final model.

I exclude elementary schools with high out-of-boundary attendance for two reasons. First, the neighborhood characteristics are not informative. If students live in many different neighborhoods, we might expect the economic inequality in the school to be far greater than the economic inequality in the school's neighborhood. Similarly, the proportion of White residents in the neighborhood does not capture the characteristics of the students' home neighborhoods. Second, out-of-district schools may select for students whose parents highly value education and have the resources to travel longer distances for drop-off and pick-up. Magnet schools in particular may select for higher preforming students, affecting the distribution of scores. 

For these reasons, many of the schools with high out-of-boundary enrollment appear as outliers in section 4.5 and in the diagnostics. I decided to exclude 22 elementary schools with high out-of-boundary enrollment. Each of the excluded schools had more out-of-boundary students enrolled than in-boundary students. After omitting these 22 schools, the final model included 334 schools in 2019 and 277 in 2009.

## 6.4 Results

Using equation 9 to model score disparities, I acheive the following results for the effect of various factors on the spread of scores. The table includes results for the chi-squared statistic of proficiency levels for English language arts and math standardized test scores for third and fifth graders. 

\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
  & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math \\ 
\\
\hline
\\
 `r i=1``r vars[i]` & `r round(final.model.3.ela$coefficients[1], 3)``r star("ela.3",1)` & `r round(final.model.3.math$coefficients[1], 3)``r star("math.3",1)` & `r round(final.model.5.ela$coefficients[1], 3)``r star("ela.5",1)` & `r round(final.model.5.math$coefficients[1], 3)``r star("math.5",1)`\\
 & (`r se$ela.3[1]`) & (`r se$math.3[1]`) &  (`r se$ela.5[1]`) & (`r se$math.5[1]`) \\
 \\
 \hline 
 \\
  `r i=2``r vars[i]` & `r round(final.model.3.ela$coefficients[2], 3)``r star("ela.3",2)` & `r round(final.model.3.math$coefficients[2], 3)``r star("math.3",2)` & `r round(final.model.5.ela$coefficients[2], 3)``r star("ela.5",2)` & `r round(final.model.5.math$coefficients[2], 3)``r star("math.5",2)`\\
  & (`r se$ela.3[2]`) & (`r se$math.3[2]`) &  (`r se$ela.5[2]`) & (`r se$math.5[2]`) \\
  \\
  `r i=3``r vars[i]` & `r round(final.model.3.ela$coefficients[3], 3)``r star("ela.3",3)`& `r round(final.model.3.math$coefficients[3], 3)``r star("math.3",3)` & `r round(final.model.5.ela$coefficients[3], 3)``r star("ela.5",3)` & `r round(final.model.5.math$coefficients[3], 3)``r star("math.5",3)`\\
  & (`r se$ela.3[3]`) & (`r se$math.3[3]`) &  (`r se$ela.5[3]`) & (`r se$math.5[3]`) \\
  \\
  \hline \\
  `r i=4``r vars[i]` &`r round(final.model.3.ela$coefficients[4], 3)``r star("ela.3",4)` & `r round(final.model.3.math$coefficients[4], 3)``r star("math.3",4)` & `r round(final.model.5.ela$coefficients[4], 3)``r star("ela.5",4)` & `r round(final.model.5.math$coefficients[4], 3)``r star("math.5",4)`\\
  & (`r se$ela.3[4]`) & (`r se$math.3[4]`) &  (`r se$ela.5[4]`) & (`r se$math.5[4]`) \\
  \\
  `r i=5``r vars[i]` & `r round(final.model.3.ela$coefficients[5], 3)``r star("ela.3",5)` & `r round(final.model.3.math$coefficients[5], 3)``r star("math.3",5)` & `r round(final.model.5.ela$coefficients[5], 3)``r star("ela.5",5)` & `r round(final.model.5.math$coefficients[5], 3)``r star("math.5",5)`\\
   & (`r se$ela.3[5]`) & (`r se$math.3[5]`) &  (`r se$ela.5[5]`) & (`r se$math.5[5]`) \\
   \\
   \hline \\
  `r i=6``r vars[i]` & `r round(final.model.3.ela$coefficients[6], 3)``r star("ela.3",6)` & `r round(final.model.3.math$coefficients[6], 3)``r star("math.3",6)` & `r round(final.model.5.ela$coefficients[6], 3)``r star("ela.5",6)` & `r round(final.model.5.math$coefficients[6], 3)``r star("math.5",6)`\\
   & (`r se$ela.3[6]`) & (`r se$math.3[6]`) &  (`r se$ela.5[6]`) & (`r se$math.5[6]`) \\
   \\
  `r i=7``r vars[i]` & `r round(final.model.3.ela$coefficients[7], 3)``r star("ela.3",7)` & `r round(final.model.3.math$coefficients[7], 3)``r star("math.3",7)` & `r round(final.model.5.ela$coefficients[7], 3)``r star("ela.5",7)`& `r round(final.model.5.math$coefficients[7], 3)``r star("math.5",7)`\\
   & (`r se$ela.3[7]`) & (`r se$math.3[7]`) &  (`r se$ela.5[7]`) & (`r se$math.5[7]`) \\
   \\
  `r i=8``r vars[i]` & `r round(final.model.3.ela$coefficients[8], 3)``r star("ela.3",8)` & `r round(final.model.3.math$coefficients[8], 3)``r star("math.3",8)` & `r round(final.model.5.ela$coefficients[8], 3)``r star("ela.5",8)` & `r round(final.model.5.math$coefficients[8], 3)``r star("math.5",8)`\\
   & (`r se$ela.3[8]`) & (`r se$math.3[8]`) &  (`r se$ela.5[8]`) & (`r se$math.5[8]`) \\
   \\
   `r i=9``r vars[i]` & `r round(final.model.3.ela$coefficients[i], 3)``r star("ela.3",i)` & `r round(final.model.3.math$coefficients[i], 3)``r star("math.3",i)` & `r round(final.model.5.ela$coefficients[i], 3)``r star("ela.5",i)` & `r round(final.model.5.math$coefficients[i], 3)``r star("math.5",i)`\\
   & (`r se$ela.3[i]`) & (`r se$math.3[i]`) &  (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
   \\
   `r i=10``r vars[i]` & `r round(final.model.3.ela$coefficients[i], 3)``r star("ela.3",i)` & `r round(final.model.3.math$coefficients[i], 3)``r star("math.3",i)` & `r round(final.model.5.ela$coefficients[i], 3)``r star("ela.5",i)` & `r round(final.model.5.math$coefficients[i], 3)``r star("math.5",i)`\\
   & (`r se$ela.3[i]`) & (`r se$math.3[i]`) &  (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
   \\
 
 \hline
 \hline
\end{tabular}
\caption{Regressing Score Spreads, 2019}{* = Significant at the 0.1 level; ** = Significant at the 0.05 level; *** = Significant at the 0.01 level}
\label{table:7}
\end{table}
\end{center}

```{r, include=F}
coefs = coefs.2009
p.values = p.values.2009
se = se.2009
```


\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
  & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math \\ 
\\
\hline \\

`r i=1``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\
& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=2``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=3``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=4``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=5``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

\hline \\
`r i=6``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\


`r i=7``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=8``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=9``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=10``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\




 \hline
 \hline
\end{tabular}
\caption{Regressing Score Disparities, 2009}{* = Significant at the 0.1 level; ** = Significant at the 0.05 level; *** = Significant at the 0.01 level}
\label{table:8}
\end{table}
\end{center}

\newpage
\begin{center}
\Large{\textsc{7. Discussion}}
\end{center}

Across all years, grades, and subjects, income inequality does not appear to be a significant predictor of the spread of scores. This finding is somewhat unsurprising given the high level of income homogeneity across Chicago neighborhoods. Since residents with similar incomes tend to cluster, the typical child attending a neighborhood school is unlikely to experience much income heterogeneity. Although there is some evidence in the literature of an effect of intra-school income inequality on scores (Campbell et al., 2008), my analysis differs by separating racial heterogeneity from income heterogeneity and by investigating score spread rather than level. Thus, after controlling for both income level (median household income) and racial homogeneity (fractionalization), income inequality does not appear to be significant.

At the same time, these results suggest that racial homogeneity does have a significant association with student outcome disparities. In 2019, fractionalization was a significant predictor of test score distribution across third and fifth grade and across math and reading scores. For all four tests, the coefficients are positive. The positive sign suggests that classroom homogeneity (as measured by the fractionalization index) is associated with a greater deviation in the distrbribution of scores, compared to the citywide average. The coefficient on fractionalization has roughly equivalent standard errors across the grades and test subjects, but the magnitude changes slightly. In 2019, racial homogeneity appears to have the greatest association with fifth grade math scores. 

The 2009 results differ slightly. Although fractionalization remains significant for third grade ELA scores, it is not significant for the other score and grade combinations. However, even the insignificant coefficients for fractionalization remain positive.

Results from both 2009 and 2019 suggest students with more classmates who share their racial background tend to have more divergent scores. It is worth noting that using the chi-squared statistic as a metric for score spread means that particularly low or high performing schools deviate greatly from the citywide mean. As a result, we might worry that the racial homogeneity factor observed in these results may be masking an effect on score \emph{level}, rather than score spread. However, Appendix A demonstrates that income and racial homogeneity appear to have no significant association with mean proficiency level after accounting for the same controls.

The change in significance for the fractionalization term from 2009 to 2019 may reflect other systemic changes within CPS. As mentioned in section 2, the 2013 school closures led to significant shifts in school attendance boundaries. These changes (which occurred between 2009 and 2019) may have affected the role that racial homogeneity plays in student outcomes. 

It is notable that these results for racial homogeneity appear even after controlling for other school and neighborhood demographics. The model controls for the absolute representation of Black and Hispanic students and the absolute representation of White residents. Additionally, the model controls for the relative racial representation of students, using the Black-White student ratio and the Black-Hispanic student ratio. Even after adjusting for these factors, the level of homogeneity remains consistently positive and often significant. 

The coefficients on the school and neighborhoods controls are also worthy of discussion. The proportion of Black and Hispanic students are both consistently significant predictors of score disparities, as is the proportion of low income students. All three predictors have uniformly negative coefficients, which suggests that they act to pull the school score distribution closer to the citywide average. Meanwhile, both neighborhood controls -- the proportion of White residents and the median household income -- are consistently close to zero and generally insignificant. 

\newpage
\begin{center}
\Large{\textsc{8. Conclusion}}
\end{center} 

This project highlights the stark patterns of residential segregation in Chicago today. A legacy of redlining and other discriminatory practices have led to persistent racial and income segregation throughout the city. The Moran's I for race and income  demonstrate high levels of spatial autocorrelation. In short, Chicagoans tend to have neighbors who look like them and earn similar incomes. 

```{r}
full = c()
for (i in 1:dim(elem.df)[1]) {
  full = c(full, rep(elem.df$prop.school.black[i], elem.df$school.black[i]))
}

median(full)*100 -> med

full = c()
for (i in 1:dim(elem.df)[1]) {
  full = c(full, rep(elem.df$prop.school.white[i], elem.df$school.white[i]))
}

median(full)*100 -> medwhite

```

These residential trends translate to schools as well. Many Chicago public elementary schools are highly homogeneous; students in many schools are surrounded by other students who look like them. This phenomenon is most pronounced for Black and Hispanic students. The typical (median) Black elementary school student attends a school that is `r med`\% Black. For comparison, the typical White student attends a school that is only `r medwhite`\% White.

This project focused on the associations between racial homogeneity, income homogeneity, and score disparities. I use different metrics to approximate each of these factors. For racial homogeneity, I use fractionalization, which represents the probability that two random students indentify with the same racial or ethnic group. For income homogeneity, I use the Gini coefficient, which measures the level of income inequality in an area. For score spread, I use the chi-squared statistic, which quantifies how dissimilar a school's proficiency level distribution is from the citywide distribution.

I fit a model to determine the relationship between racial homogeneity, income homogeneity and score disparities, after controlling for school and neighborhood characteristics. I find that income homogeneity remains consistently insignificant. Racial homogeneity is significant across grade and test subject in 2019, and is not consistently significant in 2009. This difference may be related to widespread school closures in 2013. In both years, the coefficient on fractionalization is positive, suggesting that higher levels of racial homogeneity results in score distributions that are more dissimilar to the citywide average.

More research on this topic is needed. If more detailed testing data become available, it would be worthwhile to investigate the relationships with specific test scores (rather than proficiency levels). It would also be worthwhile to investigate patterns across more years, especially immediately before and after the 2013 school closures. 

\newpage
\begin{center}
\Large{\textsc{References}}
\end{center}
\singlespacing

Aaronson, Daniel and Hartley, Daniel A. and Mazumder, Bhashkar, The Effects of the 1930s Holc 'Redlining' Maps (August 2020). FRB of Chicago Working Paper No. WP-2017-12.
\hfill\break

Campbell, Mary E., et al. “Income Inequality and Racial Gaps in Test Scores.” \emph{Steady Gains and Stalled Progress: Inequality and the Black-White Test Score Gap}, edited by Katherine Magnuson and Jane Waldfogel, Russell Sage Foundation, 2008, pp. 110–136.
\hfill\break

Chicago Public Schools. "Stats and Facts." 2021. https://www.cps.edu/about/stats-facts/.
\hfill\break

Chetty, Raj, Nathaniel Hendren, and Lawrence Katz. 2016. “The Effects of Exposure to Better  Neighborhoods on Children: New Evidence from the Moving to Opportunity Experiment.” \emph{American Economic Review} 106(4): 855–902.
\hfill\break

Chetty, Raj, John N. Friedman, Nathaniel Hilger, Emmanuel Saez, Diane Whitmore Schanzenbach, and Danny Yagan. 2011. “How Does Your Kindergarten Classroom Affect Your Earnings? Evidence from Project STAR.” \emph{Quarterly Journal of Economics}, 126:4, pp. 1593-1660.
\hfill\break

Easterly, William, and Ross Levine. “Africa's Growth Tragedy: Policies and Ethnic Divisions.” \emph{The Quarterly Journal of Economics}, vol. 112, no. 4, 1997, pp. 1203–1250. JSTOR, www.jstor.org/stable/2951270. Accessed 4 May 2021.
\hfill\break

Ewing, Eve L. \emph{Ghosts in the Schoolyard: Racism and School Closings on Chicago's South Side}.Chicago: U of Chicago, 2018.
 \hfill\break

Hing, Geoff and Jennifer Smith Richards. "Chicago School Choice in Charts." \emph{Chicago Tribune}. January 8, 2016. https://www.chicagotribune.com/ct-chicago-school-neighborhood-enrollment-charts-20160106-htmlstory.html. 
\hfill\break

Illinois State Board of Education. "REPORT CARD DATA LIBRARY." 2021. https://www.isbe.net/pages/illinois-state-report-card-data.aspx. 
\hfill\break

Krieger, Nancy, Pamela D. Waterman, Jasmina Spasojevic, Wenhui Li, Gil Maduro, and Gretchen Van Wye.
"Public Health Monitoring of Privilege and Deprivation With the Index of Concentration at the Extremes"
\emph{American Journal of Public Health}, vol. 106 (2016), pp. 256-263, https://doi.org/10.2105/AJPH.2015.302955.
\hfill\break

Moser, Whet. "How Redlining Segregated Chicago, and America." \emph{Chicago Magazine}, August 22, 2017. https://www.chicagomag.com/city-life/august-2017/how-redlining-segregated-chicago-and-america.
\hfill\break

Papay, John P., Richard J. Murnane, and John B. Willett. "Income-Based Inequality in Educational Outcomes: Learning From State Longitudinal Data Systems." \emph{Educational Evaluation and Policy Analysis},
May 2015, Vol. 37, No. 1S, pp. 29S–52S
DOI: 10.3102/0162373715576364
\hfill\break

Perkins, Kristin L. and Robert J. Sampson. “Compounded Deprivation in the Transition to Adulthood: The Intersection of Racial and Economic Inequality Among Chicagoans, 1995–2013.” RSF: The Russell Sage Foundation Journal of the Social Sciences, vol. 1, no. 1, 2015, pp. 35–54.
\hfill\break

RDocumentation. "fitdistcens: Fitting of univariate distributions to censored data." 2021. https://www.rdocumentation.org/packages/fitdistrplus/versions/1.1-3/topics/fitdistcens 
\hfill\break

Reardon, Sean F. “The Widening Academic Achievement Gap Between the Rich and the Poor: New Evidence and Possible Explanations.” Whither Opportunity?: Rising Inequality, Schools, and Children's Life Chances, edited by Greg J. Duncan and Richard J. Murnane, Russell Sage Foundation, 2011, pp. 91–116.
\hfill\break

Rothstein, Richard. \emph{The Color of Law: A Forgotten History of How Our Government Segregated America}. First ed. New York: Liveright Corporation, 2017. 
\hfill\break

Sampson, Robert J et al. “Achieving the Middle Ground in an Age of Concentrated Extremes: Mixed Middle-Income Neighborhoods and Emerging Adulthood.” \emph{The Annals of the American Academy of Political and Social Science} vol. 660,1 (2015): 156-174. doi:10.1177/0002716215576117
\hfill\break

Watson, Tara, et al. “Metropolitan Growth, Inequality, and Neighborhood Segregation by Income.” \emph{Brookings-Wharton Papers on Urban Affairs}, 2006, pp. 1–52.
\hfill\break

United States Census Bureau. "American Community Survey: Response Rates." 2021. https://www.census.gov/acs/www/methodology/sample-size-and-data-quality/response-rates/.
\hfill\break

United States Census Bureau. "Subject Definitions." 2021.  https://www.census.gov/programs-surveys/cps/technical-documentation/subject-definitions.html.
\hfill\break

Vigdor, Jacob L., and Jens Ludwig. “Segregation and the Test Score Gap.” Steady Gains and Stalled Progress: Inequality and the Black-White Test Score Gap, edited by Katherine Magnuson and Jane Waldfogel, Russell Sage Foundation, 2008, pp. 181–211.

\newpage
\doublespacing

\newpage
\begin{center}
\Large{\textsc{Appendix A: Modeling Mean Test Scores}}
\end{center}

```{r}

final.model.3.ela = update(final.model.3.ela, ela.grade3.mean ~ .)
final.model.3.math = update(final.model.3.ela, math.grade3.mean ~ .)
final.model.5.ela = update(final.model.3.ela, ela.grade5.mean ~ .)
final.model.5.math = update(final.model.3.ela, math.grade5.mean ~ .)

se = round(data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,2],
                "math.3" = summary(final.model.3.math)$coefficients[,2],
                "ela.5" = summary(final.model.5.ela)$coefficients[,2],
                "math.5" = summary(final.model.5.math)$coefficients[,2]),3)

p.values = data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,4],
                "math.3" = summary(final.model.3.math)$coefficients[,4],
                "ela.5" = summary(final.model.5.ela)$coefficients[,4],
                "math.5" = summary(final.model.5.math)$coefficients[,4])

coefs = round(data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,1],
                "math.3" = summary(final.model.3.math)$coefficients[,1],
                "ela.5" = summary(final.model.5.ela)$coefficients[,1],
                "math.5" = summary(final.model.5.math)$coefficients[,1]),3)

```

\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
  & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math \\ 
\\
\hline \\

`r i=1``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\
& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=2``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=3``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=4``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=5``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

\hline \\
`r i=6``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\


`r i=7``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=8``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=9``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=10``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\




 \hline
 \hline
\end{tabular}
\caption{Regressing Mean Scores, 2019}{* = Significant at the 0.1 level; ** = Significant at the 0.05 level; *** = Significant at the 0.01 level}
\label{table:8}
\end{table}
\end{center}

```{r}

final.model.3.ela = update(final.model.3.ela, data = elem.df.2009, ela.grade3.mean ~ .)
final.model.3.math = update(final.model.3.ela,data = elem.df.2009,  math.grade3.mean ~ .)
final.model.5.ela = update(final.model.3.ela, data = elem.df.2009, ela.grade5.mean ~ .)
final.model.5.math = update(final.model.3.ela, data = elem.df.2009, math.grade5.mean ~ .)

se = round(data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,2],
                "math.3" = summary(final.model.3.math)$coefficients[,2],
                "ela.5" = summary(final.model.5.ela)$coefficients[,2],
                "math.5" = summary(final.model.5.math)$coefficients[,2]),3)

p.values = data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,4],
                "math.3" = summary(final.model.3.math)$coefficients[,4],
                "ela.5" = summary(final.model.5.ela)$coefficients[,4],
                "math.5" = summary(final.model.5.math)$coefficients[,4])

coefs = round(data.frame("ela.3" = summary(final.model.3.ela)$coefficients[,1],
                "math.3" = summary(final.model.3.math)$coefficients[,1],
                "ela.5" = summary(final.model.5.ela)$coefficients[,1],
                "math.5" = summary(final.model.5.math)$coefficients[,1]),3)

```

\begin{center}
\begin{table}[H]
\small
\begin{tabular}{ c c c c c }
\hline
\hline
  \\
  & Grade 3 ELA & Grade 3 Math & Grade 5 ELA & Grade 5 Math \\ 
\\
\hline \\

`r i=1``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\
& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=2``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=3``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\
\hline \\

`r i=4``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=5``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

\hline \\
`r i=6``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\


`r i=7``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=8``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=9``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\

`r i=10``r vars[i]`& `r coefs$ela.3[i]``r star("ela.3", i)` & `r coefs$math.3[i]``r star("math.3", i)` &
`r coefs$ela.5[i]``r star("ela.5",i)` & `r coefs$math.5[i]``r star("math.5", i)` \\

& (`r se$ela.3[i]`) & (`r se$math.3[i]`) & (`r se$ela.5[i]`) & (`r se$math.5[i]`) \\
\\




 \hline
 \hline
\end{tabular}
\caption{Regressing Mean Scores, 2009}{* = Significant at the 0.1 level; ** = Significant at the 0.05 level; *** = Significant at the 0.01 level}
\label{table:8}
\end{table}
\end{center}


